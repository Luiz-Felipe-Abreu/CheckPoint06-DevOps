trigger:
  - main

variables:
  imageName: 'transaction'
  dockerfilePath: 'Dockerfile'
  acrName: '2tds251cp6555197.azurecr.io'
  webAppName: '2tds251cp6555197'
  tag: '$(Build.BuildId)'

pool:
  vmImage: 'ubuntu-latest'

stages:

# ============================================================
# 1) BUILD + TESTES (CI)
# ============================================================
- stage: Build
  displayName: "Build e Testes da Aplicação"
  jobs:
    - job: BuildJob
      steps:
        - checkout: self

        - task: Gradle@3
          displayName: "Executando Build e Testes"
          inputs:
            gradleWrapperFile: 'gradlew'
            tasks: 'clean build'
            publishJUnitResults: true
            testResultsFiles: '**/test-results/test/*.xml'

# ============================================================
# 2) DOCKER: BUILD + PUSH PARA ACR
# ============================================================
- stage: DockerImage
  displayName: "Build e Push da Imagem Docker"
  dependsOn: Build
  jobs:
    - job: DockerJob
      steps:

        - task: Docker@2
          displayName: "Build e Push para ACR"
          inputs:
            containerRegistry: 'ACR-SC'
            repository: '$(imageName)'
            command: 'buildAndPush'
            Dockerfile: '$(dockerfilePath)'
            tags: |
              latest
              $(tag)

# ============================================================
# 3) DEPLOY NO AZURE WEBAPP
# ============================================================
- stage: Deploy
  displayName: "Deploy Automático no Azure WebApp"
  dependsOn: DockerImage
  jobs:
    - job: DeployJob
      steps:

        # Login no ACR (garante que o WebApp consiga puxar a imagem)
        - task: AzureCLI@2
          displayName: "Login no ACR"
          inputs:
            azureSubscription: 'Azure-RM-SC'
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az acr login --name 2tds251cp6555197

        # Deploy da imagem no WebApp
        - task: AzureWebAppContainer@1
          displayName: "Deploy via Container no WebApp"
          inputs:
            azureSubscription: 'Azure-RM-SC'
            appName: '$(webAppName)'
            containers: '$(acrName)/$(imageName):latest'
